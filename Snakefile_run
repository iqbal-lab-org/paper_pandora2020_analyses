from pathlib import Path
configfile: "config.yaml"
output_dir = Path(config["pipeline_output"])


rule all:
    input:
        output_dir / "pangenome_variations/output_pangenome_variations_pandora_paper_tag1",
        output_dir / "subsampler/output_subsampler_pandora_paper_tag1",
        output_dir / "pandora_analysis_pipeline/pandora_output_pandora_paper_tag1",
        output_dir / "variant_callers_pipeline/output_other_variant_callers_pandora_paper_tag1"


rule run_pangenome_variations:
    output:
        directory(output_dir / "pangenome_variations/output_pangenome_variations_pandora_paper_tag1")
    threads: 1
    resources:
        mem_mb=16000
    log:
        "logs/run_pangenome_variations.log"
    shell:
        """
        cd {output_dir}/pangenome_variations && \
        source venv/bin/activate && \
        snakemake --profile lsf --configfile config.pandora_paper_tag1.yaml --singularity-prefix /hps/nobackup2/singularity/leandro/ >{log} 2>&1
        """


rule run_subsampler:
    output:
        directory(output_dir / "subsampler/output_subsampler_pandora_paper_tag1")
    threads: 1
    resources:
        mem_mb=16000
    log:
        "logs/run_subsampler.log"
    shell:
        """
        cd {output_dir}/subsampler && \
        source venv/bin/activate && \
        snakemake --profile lsf --configfile config.pandora_paper_tag1.yaml --singularity-prefix /hps/nobackup2/singularity/leandro/ >{log} 2>&1
        """


rule run_pandora_analysis_pipeline:
    input:
        rules.run_subsampler.output
    output:
        directory(output_dir / "pandora_analysis_pipeline/pandora_output_pandora_paper_tag1")
    threads: 16
    resources:
        mem_mb=32000
    log:
        "logs/run_pandora_analysis_pipeline.log"
    shell:
        """
        cd {output_dir}/pandora_analysis_pipeline && \
        source venv/bin/activate && \
        bash scripts/run_pipeline_lsf.sh --configfile config.pandora_paper_tag1.yaml --singularity-prefix /hps/nobackup2/singularity/leandro/ >{log} 2>&1
        """


rule run_variant_callers_pipeline:
    input:
        rules.run_subsampler.output
    output:
        directory(output_dir / "variant_callers_pipeline/output_other_variant_callers_pandora_paper_tag1")
    threads: 16
    resources:
        mem_mb=32000
    log:
        "logs/run_variant_callers_pipeline.log"
    shell:
        """
        cd {output_dir}/variant_callers_pipeline && \
        source venv/bin/activate && \
        snakemake --profile lsf --configfile config.pandora_paper_tag1.no_nanopolish.yaml --singularity-prefix /hps/nobackup2/singularity/leandro/ --keep-going >{log} 2>&1
        """
